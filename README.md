# MTG FRP Fire Progression Analyzer

Python script for create hourly and cumulative fire progression polygons from MTG (Meteosat Third Generation) FRP (Fire Radiative Power) data, with calibration against reference burned areas.

https://github.com/user-attachments/assets/198a031a-720d-4a23-9ee9-2cea6e173c95

## üìã Description

This script processes MTFRPPixel fire detection data to create temporal progression polygons of wildfires. It supports both cumulative and hourly progression modes, with advanced filtering and calibration capabilities.

## ‚ú® Features

- **Dual Processing Modes**: Cumulative progression and hourly progression for analysis and animations
- **Non-Overlapping Progression**: Option for print layouts showing only new burned areas each hour
- **Advanced Filtering**: FRP thresholding, spatial density filtering (DBSCAN), cluster size filtering and minimum area filtering
- **Flexible Hull Generation**: Concave hull with fallback to convex hull
- **Calibration System**: Automatic parameter calibration using reference burned areas
- **Temporal Continuity**: Fill missing hours to maintain temporal (hourly) progression
- **Area Correction**: Negative buffer (shrink) to mitigate area overestimation
- **Multiple Outputs**: Cumulative and hourly polygons, daily summaries, calibrated versions and non-overlapping progression

## üõ†Ô∏è Installation

### Prerequisites

```bash
# Install Python dependencies (shapely 2.x)
pip install pandas geopandas shapely scikit-learn numpy
```

### Download Script

```bash
git clone https://github.com/PedroVenancio/mtg-frp-fire-progression.git
cd mtg-fire-progression
```

## üöÄ Usage

### Basic Examples

**Process fire progression with default parameters:**
```bash
python mtg_frp_fire_progression.py --input fire_data.gpkg --output_prefix frp_fires
```

**Process with calibration using reference areas:**
```bash
python mtg_frp_fire_progression.py --input fire_data.gpkg --output_prefix calibrated_frp_fires --reference_areas reference_burned_areas.gpkg
```

**Process with non-overlapping progression (ideal for print layouts):**
```bash
python mtg_frp_fire_progression.py --input fire_data.gpkg --output_prefix print_layout --non_overlapping
```

**Process only cumulative progression:**
```bash
python mtg_frp_fire_progression.py --input fire_data.gpkg --output_prefix cumulative_only --no_hourly
```

**Custom FRP filtering and clustering:**
```bash
python mtg_frp_fire_progression.py --input fire_data.gpkg --output_prefix custom --min_frp 15 --min_cluster_size 5 --density_eps 500
```

### Advanced Examples

**Fine-tune hull generation and area correction:**
```bash
python mtg_frp_fire_progression.py --input fire_data.gpkg --output_prefix tuned \
    --ratio 0.05 \
    --buffer_distance 100 \
    --shrink_distance 40 \
    --frp_threshold_method adaptive \
    --frp_quantile_threshold 0.2
```

**Non-overlapping progression with custom minimum area:**
```bash
python mtg_frp_fire_progression.py --input fire_data.gpkg --output_prefix clean_progression \
    --non_overlapping \
    --min_area_non_overlapping 1.0
```

**Complete workflow with calibration and non-overlapping output:**
```bash
python mtg_frp_fire_progression.py --input fire_data.gpkg --output_prefix complete \
    --non_overlapping \
    --reference_areas reference_burned_areas.gpkg \
    --min_area_non_overlapping 0.5 \
    --buffer_distance 80 \
    --shrink_distance 30
```

**Skip calibration even with reference data:**
```bash
python mtg_frp_fire_progression.py --input fire_data.gpkg --output_prefix no_calib \
    --reference_areas reference.gpkg \
    --skip_calibration
```

**Process with start hour instead of end hour:**
```bash
python mtg_frp_fire_progression.py --input fire_data.gpkg --output_prefix start_hour --use_start_hour
```

**Disable missing hour filling:**
```bash
python mtg_frp_fire_progression.py --input fire_data.gpkg --output_prefix no_fill --no_fill_missing
```

## üìä Parameters

### Required Parameters
- `--input`: Input FRP data file (GeoPackage). Expects a GeoPackage generated by [MTG/MTFRPPixel Data Processor](https://github.com/PedroVenancio/mtg-frp-processor)
- `--output_prefix`: Prefix for all output files

### Core Processing Parameters
- `--fire_id_column`: Column identifying each fire (default: 'fire_id')
- `--buffer_distance`: Buffer distance in meters (default: 80)
- `--min_frp`: Minimum FRP value for filtering (default: 10)
- `--ratio`: Concave hull ratio parameter 0-1 (default: 0.08)
- `--min_cluster_size`: Minimum cluster size for polygons (default: 3)
- `--density_eps`: DBSCAN epsilon distance in meters (default: 300)
- `--shrink_distance`: Negative buffer distance in meters (default: 30)

### Non-Overlapping Progression Parameters
- `--non_overlapping`: Generate non-overlapping progression (useful for print layouts)
- `--min_area_non_overlapping`: Minimum area in hectares for non-overlapping polygons (default: 0.5)

### Processing Flags
- `--no_cumulative`: Disable cumulative progression
- `--no_hourly`: Disable hourly progression  
- `--no_fill_missing`: Disable filling missing hours
- `--no_density_filter`: Disable density filtering
- `--use_start_hour`: Use start hour instead of end hour

### Calibration Parameters
- `--reference_areas`: Reference burned areas file for calibration
- `--skip_calibration`: Skip calibration even if reference areas provided
- `--frp_threshold_method`: FRP threshold method: 'fixed' or 'adaptive' (default: adaptive)
- `--frp_quantile_threshold`: Quantile for adaptive FRP threshold (default: 0.15)

## üóÇÔ∏è Output Structure

### Generated Files
- `{prefix}_cumulative_initial.gpkg` - Initial cumulative progression
- `{prefix}_hourly_initial.gpkg` - Initial hourly progression  
- `{prefix}_cumulative_calibrated.gpkg` - Calibrated cumulative progression (if calibration applied)
- `{prefix}_hourly_calibrated.gpkg` - Calibrated hourly progression (if calibration applied)
- `{prefix}_daily_cumulative_initial.gpkg` - Daily summary of cumulative progression
- `{prefix}_daily_hourly_initial.gpkg` - Daily summary of hourly progression
- `{prefix}_daily_cumulative_calibrated.gpkg` - Calibrated daily summary (if calibration applied)
- `{prefix}_daily_hourly_calibrated.gpkg` - Calibrated daily summary (if calibration applied)

### Non-Overlapping Progression Files
- `{prefix}_non_overlapping_hourly_initial.gpkg` - Hourly non-overlapping progression (initial)
- `{prefix}_non_overlapping_hourly_calibrated.gpkg` - Hourly non-overlapping progression (calibrated)
- `{prefix}_daily_non_overlapping_initial.gpkg` - Daily non-overlapping summary (initial)
- `{prefix}_daily_non_overlapping_calibrated.gpkg` - Daily non-overlapping summary (calibrated)

### Data Structure
Files contain:
- `fire_id`: Fire identifier
- `datetime_hour`: Hour in UTC
- `datetime_display`: Display hour (end hour by default)
- `geometry`: Progression polygon
- `area_ha`: Area in hectares
- `n_points_current_hour`: Points in current hour
- `n_points_cumulative`: Cumulative points (cumulative version)
- `frp_current_hour`: FRP in current hour
- `frp_cumulative`: Cumulative FRP (cumulative version)
- `hull_type`: Type of hull used ('concave', 'convex', etc.)
- `data_status`: Data origin ('original', 'filled')
- `shrink_applied`: Whether negative buffer was applied
- `shrink_distance_m`: Shrink distance in meters

### Non-Overlapping Specific Fields
- `area_ha_new`: New area burned in this time step (hectares)
- `area_ha_cumulative`: Total cumulative area up to this time step
- `progression_type`: 'non_overlapping' or 'daily_non_overlapping'

## üîß Processing Details

### Algorithm Overview

1. **Data Filtering**: 
   - FRP thresholding (fixed or adaptive)
   - Spatial density filtering (DBSCAN)
   - Cluster size filtering

2. **Temporal Processing**:
   - UTC timezone enforcement
   - Hourly binning
   - Missing hour filling (optional)

3. **Polygon Generation**:
   - Concave hull with progressive ratio
   - Convex hull fallback
   - Positive buffer for smoothing
   - Negative buffer for area correction

4. **Non-Overlapping Progression**:
   - Calculate geometric difference between consecutive time steps
   - Show only new burned areas for each hour
   - Apply minimum area filter (default: 0.5 ha)
   - Create daily summaries of new burned areas

5. **Calibration**:
   - Compare with reference burned areas
   - Calculate overestimation ratios
   - Suggest optimal shrink distance

### Calibration Process

The calibration system:
- Matches fires between FRP data and reference areas
- Calculates overestimation percentages
- Suggests optimal `shrink_distance` parameter
- Heuristic: 10 meters shrink per 10% overestimation
- Limits suggested shrink between 20-80 meters

### Non-Overlapping Progression

The non-overlapping progression:
- Shows only the **new area burned** in each time step
- Ideal for print layouts and progression visualization
- Filters out small polygons (< 0.5 ha by default)
- Maintains temporal sequence without overlaps
- Provides cleaner visualization of fire spread patterns

## üí° Usage Tips

### For Best Results

**Data Preparation:**
- Get FRP data from [MTG/MTFRPPixel Data Processor](https://github.com/PedroVenancio/mtg-frp-processor)
- Ensure consistent fire_id between FRP and reference data
- Use projected CRS (meters) for accurate distance calculations
- Clean invalid geometries before processing

**Parameter Tuning:**
- Start with `ratio=0.08` and adjust based on point density
- Use `adaptive` FRP threshold for datasets with varying fire intensities
- Set `min_cluster_size=2` for detecting small fires
- Increase `density_eps` for more dispersed fire patterns
- Use `min_area_non_overlapping=1.0` for cleaner print layouts

**Memory Management:**
- Process large datasets in batches by fire_id
- Use `--no_hourly` or `--no_cumulative` to reduce output size
- Monitor RAM usage with very large input files

### QGIS Integration

1. **Visualization**:
   - Style by `datetime_hour` or `datetime_display` for temporal visualization and animation 
   - Use graduated symbols for `area_ha`
   - Filter by `data_status` to identify filled hours

2. **Animation**:
   - Use cumulative version with `datetime_hour` or `datetime_display` for temporal animation using QGIS Temporal Controller Panel
   - Daily summaries provide cleaner animation frames for large time frames

3. **Print Layouts**:
   - Use **non-overlapping progression** for clear progression maps
   - Each time step shows only new burned area
   - Perfect for static maps showing fire spread sequence

4. **Analysis**:
   - Hourly version for detailed temporal analysis
   - Compare calibrated vs initial versions for accuracy assessment
   - Intersect with reference data to get better statistics and make it closer to the reality

## üêõ Troubleshooting

### Common Issues

**No polygons created:**
- Check FRP filtering thresholds
- Verify minimum cluster size
- Ensure valid fire_id values (not -1 or NaN)

**Overestimation issues:**
- Increase `shrink_distance`
- Use calibration with reference areas
- Adjust `ratio` parameter for tighter hulls

**Memory errors:**
- Process fires individually
- Increase `min_cluster_size` to reduce polygon count
- Use `--no_fill_missing` to reduce output size

**Temporal gaps:**
- Enable `fill_missing_hours` (default)
- Check input data temporal continuity
- Verify timezone handling

**Too many small polygons in non-overlapping output:**
- Increase `min_area_non_overlapping` (try 1.0 or 2.0 ha)
- Check if `shrink_distance` is appropriate
- Verify FRP filtering thresholds

### Performance Optimization

**For large datasets:**
```bash
# Process with stricter filtering
python mtg_frp_fire_progression.py --input large_data.gpkg --output_prefix optimized \
    --min_cluster_size 5 \
    --min_frp 20 \
    --no_hourly
```

**For high precision:**
```bash
# Use tighter parameters and calibration
python mtg_frp_fire_progression.py --input precise_data.gpkg --output_prefix precise \
    --ratio 0.05 \
    --buffer_distance 50 \
    --reference_areas high_quality_reference.gpkg
```

**For print-ready progression maps:**
```bash
# Generate clean non-overlapping progression
python mtg_frp_fire_progression.py --input fire_data.gpkg --output_prefix print_ready \
    --non_overlapping \
    --min_area_non_overlapping 1.0 \
    --buffer_distance 80 \
    --shrink_distance 40
```

## üìù Complete Workflow Example

```bash
# 1. Process with calibration and non-overlapping progression
python mtg_frp_fire_progression.py --input mtg_frp_data.gpkg --output_prefix fire_progression \
    --non_overlapping \
    --reference_areas sentinel2_burned_areas.gpkg

# 2. Analyze results in QGIS
# Files: fire_progression_*.gpkg

# 3. Compare calibrated vs initial
# Open both cumulative versions and compare areas

# 4. Create temporal animation
# Use cumulative_calibrated with datetime_hour or datetime_display for animation

# 5. Create print layouts
# Use non_overlapping_hourly_calibrated for clear progression maps
```

## üîí Data Requirements

### Input Data ([MTG/MTFRPPixel Data Processor](https://github.com/PedroVenancio/mtg-frp-processor))
- FRP data with geometry and fire_id column
- Valid datetime information (acquisition_datetime or ACQTIME)
- FRP values for filtering

### Reference Data (for calibration)
- Burned area polygons with matching fire_id
- Same spatial extent as FRP data
- Preferably from high-resolution sources (Sentinel-2, Landsat)

## üìÑ License

This project is distributed under the MIT License. See LICENSE file for details.

## üôã Support

For issues and questions:
1. Check troubleshooting section
2. Create GitHub issue
3. Contact project maintainer

## üìö References

- [MTG/MTFRPPixel Data Processor](https://github.com/PedroVenancio/mtg-frp-processor)
- [LSA SAF Product Documentation](https://lsa-saf.eumetsat.int/en/news/news/2025/10/01/release-of-mtg-fire-radiative-power-product-as-demonstration/)
- [MTG Mission Overview](https://www.eumetsat.int/meteosat-third-generation)
- [QGIS Documentation](https://qgis.org/resources/hub/)
- [QGIS Time-based control on the map canvas](https://docs.qgis.org/3.40/en/docs/user_manual/map_views/map_view.html#time-based-control-on-the-map-canvas)

---

**Note**: This tool is designed to work with MTG FRP data but can be adapted for other fire detection datasets with similar structure.
